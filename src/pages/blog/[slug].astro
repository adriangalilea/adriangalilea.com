---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import HumanDate from "@/components/HumanDate.astro";
import { Image } from "astro:assets";
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<"blog">;
};

const { post } = Astro.props;
const { Content } = await post.render();

// Check if this is a directory post with a header.png
const headerPath = path.join(process.cwd(), 'src/content/blog', post.slug, 'header.png');
const hasHeaderImage = fs.existsSync(headerPath);

// Always use generated OG image for consistent SEO
// Use post OG image
const ogImageUrl = `${Astro.site?.origin}/og/${post.slug}.png`;

// Direct overrides for Twitter/OG description
const ogMetadata = {
  title: post.data.title,
  description: post.data.description,
  type: "website",
  image: ogImageUrl,
  alt: `Header image for ${post.data.title}`
};

// Dynamically import the header image if it exists
let headerImage;
if (hasHeaderImage) {
  // We use a relative path to import the image as a module
  headerImage = await import(`../../content/blog/${post.slug}/header.png`);
}
---

<Layout
  title={post.data.title}
  description={post.data.description}
  imgLink={ogImageUrl}
  og={ogMetadata}
>
  <main class="flex-col gap-4 max-w-full">
    <article
      class="prose prose-zinc lg:prose-lg xl:prose-xl dark:prose-invert text-pretty prose-a:no-underline prose-a:text-emerald-500 hover:prose-a:underline prose-h1:font-extralight prose-h2:font-extralight prose-h3:font-extralight prose-p:!mt-0"
    >
      <div class="border-b border-neutral-300 dark:border-neutral-700">
        <h1 class="text-balance font-light !mb-0">
          {post.data.title}
        </h1>
        
        {/* Header image placed between title and description, full-width */}
        {headerImage && (
          <div class="w-[calc(100%+2rem)] -mx-4 md:w-[calc(100%+4rem)] md:-mx-8 my-4 overflow-hidden rounded-lg">
            <Image 
              src={headerImage.default}
              alt={`Header image for ${post.data.title}`}
              class="w-full h-auto object-cover"
              width={1200}
              height={630}
              loading="eager"
            />
          </div>
        )}
        
        <p class="text-balance">{post.data.description}</p>
        <div class="flex justify-between opacity-80">
          <HumanDate compare={post.data.publishedAt} type="published" />
          {
            post.data.editedAt && (
              <HumanDate compare={post.data.editedAt} type="edited" />
            )
          }
        </div>
      </div>
      
      <Content />
    </article>
  </main>
</Layout>
